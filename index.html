<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math.AI Analyzer</title>
    <script>
        window.MathJax = {
            tex: {inlineMath: [['$', '$']], displayMath: [['$$', '$$']]},
            startup: {pageReady: () => MathJax.startup.defaultPageReady()}
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { color: #4361ee; }
        .user-info { float: right; }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #4361ee; color: white; }
        .btn-outline { background: white; border: 1px solid #ddd; }
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .upload-card { background: white; padding: 30px; border-radius: 8px; text-align: center; border: 2px dashed #ddd; cursor: pointer; }
        .upload-card:hover { border-color: #4361ee; }
        .hidden { display: none; }
        .sidebar { position: fixed; left: 0; top: 0; width: 280px; height: 100vh; background: white; border-right: 1px solid #eee; overflow-y: auto; padding: 20px; }
        .main-content { margin-left: 300px; }
        .sidebar-item { padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 8px; cursor: pointer; }
        .sidebar-item:hover { background: #e9ecef; }
        .sidebar-item.active { background: #4361ee; color: white; }
        .accordion-item { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .accordion-content { display: none; margin-top: 15px; }
        .accordion-content.open { display: block; }
        .solution-card { background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .badge { display: inline-block; padding: 6px 12px; border-radius: 6px; margin: 5px; font-size: 13px; }
        .correct { background: #d1fae5; color: #065f46; }
        .incorrect { background: #fee2e2; color: #991b1b; }
        .partial { background: #fef3c7; color: #92400e; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.open { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; }
        .form-group { margin: 15px 0; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .error-message { color: #dc2626; font-size: 13px; margin-top: 5px; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f4f6; border-top-color: #4361ee; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .corrected-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin: 20px 0; }
        .corrected-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .corrected-card img { width: 100%; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>
    <!-- Login -->
    <div id="loginPage" class="container" style="max-width: 400px; margin-top: 100px;">
        <div class="header">
            <h1>Math.AI Analyzer</h1>
            <p>AI-Powered Math Analysis</p>
        </div>
        <div style="background: white; padding: 30px; border-radius: 8px;">
            <form id="loginForm">
                <div class="form-group">
                    <input type="text" id="loginUsername" class="form-input" placeholder="Username" required>
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" class="form-input" placeholder="Password" required>
                </div>
                <div id="loginError" class="error-message"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                <button type="button" class="btn btn-outline" style="width: 100%; margin-top: 10px;" onclick="showRegister()">Register</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <div class="sidebar">
            <h2 style="margin-bottom: 20px;">History</h2>
            <div id="historyList"></div>
        </div>
        <div class="main-content">
            <div class="header">
                <h1>Math.AI Analyzer</h1>
                <div class="user-info">
                    <span id="userName"></span>
                    <button class="btn btn-outline" onclick="logout()" style="margin-left: 10px;">Logout</button>
                </div>
            </div>

            <!-- Upload -->
            <div id="uploadSection" class="container">
                <h2>Upload Files</h2>
                <div class="upload-grid">
                    <div class="upload-card" onclick="document.getElementById('questionInput').click()">
                        <h3>üìÑ Question Papers</h3>
                        <p>Upload question papers</p>
                        <input type="file" id="questionInput" multiple accept="image/*,.pdf" style="display:none;">
                        <div id="questionList"></div>
                    </div>
                    <div class="upload-card" onclick="document.getElementById('answerInput').click()">
                        <h3>‚úèÔ∏è Answer Sheets</h3>
                        <p>Upload student answers</p>
                        <input type="file" id="answerInput" multiple accept="image/*,.pdf" style="display:none;">
                        <div id="answerList"></div>
                    </div>
                </div>
                <button id="startBtn" class="btn btn-primary" onclick="startAnalysis()" disabled>Start Analysis</button>
            </div>

            <!-- Results -->
            <div id="resultsSection" class="container hidden">
                <h2>Analysis Results</h2>
                <div id="badges"></div>
                <div id="accordion"></div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generatePractice()">Generate Practice Paper</button>
                    <button class="btn btn-primary" onclick="findErrors()">Find Errors (Bounding Boxes)</button>
                    <button id="viewCorrectedBtn" class="btn btn-outline hidden" onclick="viewCorrected()">View Corrected</button>
                </div>
                <div id="correctedSection" class="hidden">
                    <h3>Corrected Papers</h3>
                    <div id="correctedGallery" class="corrected-gallery"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h2>Register</h2>
            <form id="registerForm">
                <div class="form-group">
                    <input type="text" id="regUsername" class="form-input" placeholder="Username (3+ chars)" required>
                </div>
                <div class="form-group">
                    <input type="tel" id="regPhone" class="form-input" placeholder="Phone" required>
                </div>
                <div class="form-group">
                    <input type="password" id="regPassword" class="form-input" placeholder="Password (6+ chars)" required>
                </div>
                <div id="regError" class="error-message"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
                <button type="button" class="btn btn-outline" style="width: 100%; margin-top: 10px;" onclick="closeRegister()">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        const API = 'https://navalsheth.pythonanywhere.com';
        let qFiles = [], aFiles = [], allFiles = [], result = null;

        function renderMath(el) {
            if (window.MathJax) MathJax.typesetPromise([el]).catch(e => console.error(e));
        }

        // Auth
        async function checkAuth() {
            const res = await fetch(`${API}/api/check-auth`, {credentials: 'include'});
            const data = await res.json();
            if (data.authenticated) {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('userName').textContent = data.user.username;
                loadHistory();
                return true;
            }
            return false;
        }

        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const res = await fetch(`${API}/api/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({
                    username: document.getElementById('loginUsername').value,
                    password: document.getElementById('loginPassword').value
                })
            });
            const data = await res.json();
            if (data.success) checkAuth();
            else document.getElementById('loginError').textContent = data.message;
        };

        document.getElementById('registerForm').onsubmit = async (e) => {
            e.preventDefault();
            const res = await fetch(`${API}/api/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({
                    username: document.getElementById('regUsername').value,
                    phone: document.getElementById('regPhone').value,
                    password: document.getElementById('regPassword').value
                })
            });
            const data = await res.json();
            if (data.success) { closeRegister(); alert('Registered! Please login.'); }
            else document.getElementById('regError').textContent = data.message;
        };

        function showRegister() { document.getElementById('registerModal').classList.add('open'); }
        function closeRegister() { document.getElementById('registerModal').classList.remove('open'); }
        async function logout() {
            await fetch(`${API}/api/logout`, {method: 'POST', credentials: 'include'});
            location.reload();
        }

        // Files
        document.getElementById('questionInput').onchange = (e) => {
            qFiles = Array.from(e.target.files);
            document.getElementById('questionList').innerHTML = qFiles.map(f => `<div>${f.name}</div>`).join('');
            checkStart();
        };
        document.getElementById('answerInput').onchange = (e) => {
            aFiles = Array.from(e.target.files);
            document.getElementById('answerList').innerHTML = aFiles.map(f => `<div>${f.name}</div>`).join('');
            checkStart();
        };
        function checkStart() {
            document.getElementById('startBtn').disabled = qFiles.length === 0 || aFiles.length === 0;
        }

        // Analysis
        async function startAnalysis() {
            allFiles = [...qFiles, ...aFiles];
            const fd = new FormData();
            allFiles.forEach(f => fd.append('files', f));
            
            document.getElementById('startBtn').innerHTML = '<div class="loading"></div> Analyzing...';
            document.getElementById('startBtn').disabled = true;

            const res = await fetch(`${API}/analyze`, {method: 'POST', body: fd, credentials: 'include'});
            result = await res.json();

            displayResults(result);
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('startBtn').innerHTML = 'Start Analysis';
            document.getElementById('startBtn').disabled = false;
        }

        function displayResults(data) {
            const counts = {correct: 0, partial: 0, incorrect: 0};
            data.questions.forEach(q => counts[q.status]++);
            
            document.getElementById('badges').innerHTML = `
                <span class="badge correct">${counts.correct} Correct</span>
                <span class="badge partial">${counts.partial} Partial</span>
                <span class="badge incorrect">${counts.incorrect} Incorrect</span>
            `;

            const html = data.questions.map((q, i) => `
                <div class="accordion-item">
                    <div onclick="toggle(${i})" style="cursor: pointer;">
                        <strong>Q${q.number}</strong>: ${q.question} 
                        <span class="badge ${q.status}">${q.status}</span>
                    </div>
                    <div id="acc${i}" class="accordion-content">
                        <div class="solution-card">
                            <strong>Student Solution:</strong><br>${q.student_original}
                        </div>
                        <div class="solution-card">
                            <strong>Error:</strong> ${q.error}
                        </div>
                        <div class="solution-card">
                            <strong>Corrected:</strong><br>${q.correct_solution}
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('accordion').innerHTML = html;
            setTimeout(() => renderMath(document.getElementById('accordion')), 100);
        }

        function toggle(i) {
            document.getElementById(`acc${i}`).classList.toggle('open');
        }

        // Practice
        async function generatePractice() {
            const res = await fetch(`${API}/generate_practice`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({analysis: result})
            });
            const data = await res.json();
            if (data.practice_questions.length === 0) {
                alert('All correct! No practice needed.');
                return;
            }
            const html = `<h3>Practice Paper</h3>` + 
                data.practice_questions.map(p => `<div class="solution-card"><strong>Q${p.number}:</strong> ${p.question}</div>`).join('');
            document.getElementById('accordion').innerHTML += `<div style="margin-top: 30px;">${html}</div>`;
            renderMath(document.getElementById('accordion'));
        }

        // Bounding boxes
        async function findErrors() {
            const fd = new FormData();
            allFiles.forEach(f => fd.append('files', f));
            
            const res = await fetch(`${API}/api/bounding-analyze`, {method: 'POST', body: fd, credentials: 'include'});
            const data = await res.json();
            
            if (data.success) {
                window.correctedImages = data.corrected_images;
                document.getElementById('viewCorrectedBtn').classList.remove('hidden');
                alert(`Found ${data.errors_found} errors!`);
            }
        }

        function viewCorrected() {
            const html = window.correctedImages.map(img => `
                <div class="corrected-card">
                    <h4>${img.error_count} Error(s)</h4>
                    <img src="${img.image_base64}" onclick="window.open(this.src, '_blank')">
                </div>
            `).join('');
            document.getElementById('correctedGallery').innerHTML = html;
            document.getElementById('correctedSection').classList.remove('hidden');
        }

        // History
        async function loadHistory() {
            const res = await fetch(`${API}/api/get-analyses`, {credentials: 'include'});
            const data = await res.json();
            if (data.success) {
                document.getElementById('historyList').innerHTML = data.analyses.map(a => `
                    <div class="sidebar-item" onclick="loadAnalysis(${a.id})">
                        ${a.title}
                    </div>
                `).join('');
            }
        }

        async function loadAnalysis(id) {
            const res = await fetch(`${API}/api/get-analysis/${id}`, {credentials: 'include'});
            const data = await res.json();
            if (data.success && data.analysis.analysis_structure) {
                result = {questions: data.analysis.analysis_structure.questions};
                displayResults(result);
                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
            }
        }

        // Init
        checkAuth();
    </script>
</body>
</html>
