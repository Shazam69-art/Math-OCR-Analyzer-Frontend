<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CAS Educations - Math OCR Analyzer</title>
    <link rel="stylesheet" href="style.css" />
    <!-- KaTeX for proper math rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
    <!-- html2pdf for client-side PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.0/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>CAS Educations - Math OCR Analyzer</h1>
            <p>Advanced mathematical analysis with real-time feedback</p>
        </div>
        <!-- Main Interface -->
        <div id="mainInterface" class="section main-interface">
            <!-- Upload Section -->
            <div class="section upload-section">
                <div class="upload-buttons">
                    <button id="uploadQuestionBtn" class="btn upload-btn">
                        <span class="btn-icon">üìÑ</span>
                        Upload Question Paper (Images Only)
                        <span id="questionCount" class="file-count"></span>
                    </button>
                    <button id="uploadSolutionBtn" class="btn upload-btn">
                        <span class="btn-icon">‚úçÔ∏è</span>
                        Upload Your Solution (Images Only)
                        <span id="solutionCount" class="file-count"></span>
                    </button>
                </div>
                <input type="file" id="questionInput" hidden multiple accept=".jpg,.jpeg,.png" />
                <input type="file" id="solutionInput" hidden multiple accept=".jpg,.jpeg,.png" />
             
                <div class="dropdown-section">
                    <label>Select Class and Topic (Optional):</label>
                    <select id="classTopicDropdown" class="dropdown">
                        <option value="">Select...</option>
                        <option value="class11">Class 11</option>
                        <option value="class12">Class 12</option>
                    </select>
                    <div id="class12Submenu" class="submenu" style="display:none;">
                        <div class="dropdown-option" onclick="selectChapter('integration-substitution', 'Integration - Substitution')">
                            Integration - Substitution
                        </div>
                        <div class="dropdown-option" onclick="selectChapter('differentiation', 'Differentiation')">
                            Differentiation
                        </div>
                        <div class="dropdown-option" onclick="selectChapter('limits', 'Limits and Continuity')">
                            Limits and Continuity
                        </div>
                    </div>
                </div>
             
                <!-- Analysis Buttons -->
                <div class="analysis-buttons">
                    <button id="generalAnalysisBtn" class="btn primary-btn" disabled>
                        <span class="btn-icon">üîç</span>
                        Start General Analysis
                    </button>
                </div>
             
                <div id="confirmationSection" class="confirmation-section" style="display:none;">
                    <p id="confirmationMessage"></p>
                    <div class="confirmation-buttons">
                        <button id="beginYes" class="btn confirm-btn">Yes, Begin Analysis</button>
                        <button id="beginNo" class="btn cancel-btn">No, Go Back</button>
                    </div>
                </div>
             
                <div id="progressSection" class="progress-section" style="display:none;">
                    <div class="progress-container">
                        <h3>Analyzing your work...</h3>
                        <p>This may take a few moments. Please wait while we process your files.</p>
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <div id="progressMessages" class="progress-messages"></div>
                    </div>
                </div>
             
                <div id="analysisCompleteSection" class="complete-section" style="display:none;">
                    <div class="success-message">
                        <span class="success-icon">‚úì</span>
                        <p>Analysis complete! Generate reports below.</p>
                    </div>
                </div>
            </div>
            <!-- Report Buttons -->
            <div class="section report-section">
                <h3>Generate Reports:</h3>
                <div class="control-buttons">
                    <button id="conceptGapsBtn" class="btn report-btn" disabled>
                        <span class="btn-icon">üìä</span>
                        Analysis Report (Concept Gaps)
                    </button>
                    <button id="detailedAnalysisBtn" class="btn report-btn" disabled>
                        <span class="btn-icon">üî¨</span>
                        Detailed Analysis (Paper Evaluations)
                    </button>
                    <button id="createPaperBtn" class="btn report-btn" disabled>
                        <span class="btn-icon">üìù</span>
                        Create Your Paper Based on Mistakes
                    </button>
                </div>
            </div>
        </div>
        <!-- Performance Report Screen -->
        <div id="conceptGapsScreen" class="section report-screen">
            <div class="report-header">
                <div class="control-buttons">
                    <button id="backToAnalysis" class="btn back-btn">‚Üê Back to Main</button>
                    <button id="downloadConceptGaps" class="btn download-btn">üì• Download PDF</button>
                </div>
                <h2>Performance Analysis Report</h2>
            </div>
            <div id="conceptGapsContent" class="report-content"></div>
        </div>
        <!-- Detailed Analysis Screen -->
        <div id="detailedAnalysisScreen" class="section report-screen">
            <div class="report-header">
                <div class="control-buttons">
                    <button id="backToAnalysisDetailed" class="btn back-btn">‚Üê Back to Main</button>
                    <button id="downloadDetailed" class="btn download-btn">üì• Download PDF</button>
                </div>
                <h2>Detailed Analysis (Question by Question)</h2>
            </div>
            <div id="detailedContent" class="detailed-content"></div>
        </div>
        <!-- Practice Paper Screen -->
        <div id="practicePaperScreen" class="section report-screen">
            <div class="report-header">
                <div class="control-buttons">
                    <button id="backToAnalysisPractice" class="btn back-btn">‚Üê Back to Main</button>
                    <button id="downloadPractice" class="btn download-btn">üì• Download PDF</button>
                </div>
                <h2>Practice Paper Based on Your Conceptual Errors</h2>
            </div>
            <div id="practicePaperContent" class="practice-content"></div>
        </div>
    </div>
    <script>
        let questionFiles = [], solutionFiles = [], selectedChapter = '', analysisData = {}, detailedData = {}, practicePaperData = null;
        let streamingEnabled = true;
        function selectChapter(chapterValue, chapterName) {
            selectedChapter = chapterValue;
            document.getElementById('confirmationMessage').innerHTML =
                `Chapter <strong>${chapterName}</strong> selected! <br>Begin the analysis process?`;
            document.getElementById('confirmationSection').style.display = 'block';
            document.getElementById('class12Submenu').style.display = 'none';
        }
        // Upload buttons
        document.getElementById('uploadQuestionBtn').onclick = () => document.getElementById('questionInput').click();
        document.getElementById('questionInput').onchange = e => {
            questionFiles = Array.from(e.target.files);
            updateUploadStatus('question');
            checkAnalysisReady();
        };
        document.getElementById('uploadSolutionBtn').onclick = () => document.getElementById('solutionInput').click();
        document.getElementById('solutionInput').onchange = e => {
            solutionFiles = Array.from(e.target.files);
            updateUploadStatus('solution');
            checkAnalysisReady();
        };
     
        function updateUploadStatus(type) {
            const btn = document.getElementById(type === 'question' ? 'uploadQuestionBtn' : 'uploadSolutionBtn');
            const count = (type === 'question' ? questionFiles : solutionFiles).length;
            const countSpan = document.getElementById(type === 'question' ? 'questionCount' : 'solutionCount');
         
            if (count > 0) {
                countSpan.textContent = ` (${count})`;
                countSpan.style.display = 'inline';
            } else {
                countSpan.style.display = 'none';
            }
        }
        function checkAnalysisReady() {
            const generalBtn = document.getElementById('generalAnalysisBtn');
            const conceptBtn = document.getElementById('conceptGapsBtn');
            const detailedBtn = document.getElementById('detailedAnalysisBtn');
            const paperBtn = document.getElementById('createPaperBtn');
         
            if (questionFiles.length > 0 && solutionFiles.length > 0) {
                generalBtn.disabled = false;
                document.getElementById('classTopicDropdown').disabled = false;
                // Enable report buttons immediately after upload
                conceptBtn.disabled = false;
                detailedBtn.disabled = false;
                paperBtn.disabled = false;
            } else {
                generalBtn.disabled = true;
            }
        }
        // Dropdown handling
        document.getElementById('classTopicDropdown').onchange = function() {
            const submenu = document.getElementById('class12Submenu');
            if (this.value === 'class12') {
                submenu.style.display = 'block';
            } else {
                submenu.style.display = 'none';
                selectedChapter = '';
            }
        };
        // General Analysis Button
        document.getElementById('generalAnalysisBtn').onclick = async () => {
            if (questionFiles.length === 0 || solutionFiles.length === 0) {
                alert('Please upload both question paper and solution files first.');
                return;
            }
         
            // Check for PDF files and warn user
            const hasPDF = [...questionFiles, ...solutionFiles].some(file =>
                file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
            );
         
            if (hasPDF) {
                alert('PDF files are not supported in the current configuration. Please convert your PDFs to images (JPG/PNG) and try again.');
                return;
            }
         
            document.getElementById('confirmationSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            startProgressAnimation();
         
            await performGeneralAnalysis();
         
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('analysisCompleteSection').style.display = 'block';
            document.getElementById('conceptGapsBtn').disabled = false;
            document.getElementById('detailedAnalysisBtn').disabled = false;
            document.getElementById('createPaperBtn').disabled = false;
        };
        // Confirmation for specific analysis
        document.getElementById('beginYes').onclick = async () => {
            document.getElementById('confirmationSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            startProgressAnimation();
         
            await performAnalysis();
         
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('analysisCompleteSection').style.display = 'block';
            document.getElementById('conceptGapsBtn').disabled = false;
            document.getElementById('detailedAnalysisBtn').disabled = false;
            document.getElementById('createPaperBtn').disabled = false;
        };
        document.getElementById('beginNo').onclick = () => {
            document.getElementById('confirmationSection').style.display = 'none';
        };
        // Progress animation with streaming effect
        function startProgressAnimation() {
            const messages = [
                "Reading mathematical expressions...",
                "Analyzing solution steps...",
                "Checking for conceptual errors...",
                "Verifying calculations...",
                "Comparing with standard methods...",
                "Identifying common mistakes...",
                "Evaluating step-by-step logic...",
                "Checking final answers...",
                "Analyzing integration techniques...",
                "Verifying differentiation steps...",
                "Checking algebraic manipulations...",
                "Analyzing trigonometric identities...",
                "Verifying logarithmic properties...",
                "Checking exponential functions...",
                "Analyzing limit calculations...",
                "Verifying derivative applications...",
                "Checking integral bounds...",
                "Analyzing substitution methods...",
                "Verifying partial fractions...",
                "Generating comprehensive report..."
            ];
         
            const progressFill = document.querySelector('.progress-fill');
            const messagesContainer = document.getElementById('progressMessages');
            let currentMessage = 0;
         
            progressFill.style.width = '0%';
            messagesContainer.innerHTML = '';
         
            const interval = setInterval(() => {
                if (currentMessage < messages.length) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'progress-message';
                 
                    // Create streaming effect
                    const text = messages[currentMessage];
                    let charIndex = 0;
                 
                    messageDiv.textContent = '‚Ä¢ ';
                    messagesContainer.appendChild(messageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                 
                    const typeInterval = setInterval(() => {
                        if (charIndex < text.length) {
                            messageDiv.textContent = '‚Ä¢ ' + text.substring(0, charIndex + 1);
                            charIndex++;
                        } else {
                            clearInterval(typeInterval);
                        }
                    }, 30);
                 
                    const progress = ((currentMessage + 1) / messages.length) * 100;
                    progressFill.style.width = `${progress}%`;
                 
                    currentMessage++;
                } else {
                    clearInterval(interval);
                }
            }, 1200);
        }
        async function performGeneralAnalysis() {
            const fd = new FormData();
            questionFiles.forEach(f => fd.append('files', f));
            solutionFiles.forEach(f => fd.append('files', f));
            fd.append('question_count', questionFiles.length);
            fd.append('message', 'Perform a general mathematical analysis of these papers. Identify all questions, analyze student solutions step by step, detect conceptual errors, and provide corrected solutions with proper mathematical reasoning.');
         
            try {
                const r = await fetch('/analyze-chat', {method:'POST', body:fd});
                const d = await r.json();
                analysisData = d.response;
                detailedData = d.detailed_data || { questions: [] };
             
                // Force KaTeX rendering
                setTimeout(() => {
                    renderKaTeX();
                }, 1000);
            } catch (e) {
                console.error(e);
                alert('Analysis failed. Please try again.');
            }
        }
        async function performAnalysis() {
            const fd = new FormData();
            questionFiles.forEach(f => fd.append('files', f));
            solutionFiles.forEach(f => fd.append('files', f));
            fd.append('question_count', questionFiles.length);
            fd.append('message', `Analyze for ${selectedChapter}`);
         
            try {
                const r = await fetch('/analyze-chat', {method:'POST', body:fd});
                const d = await r.json();
                analysisData = d.response;
                detailedData = d.detailed_data || { questions: [] };
             
                // Force KaTeX rendering
                setTimeout(() => {
                    renderKaTeX();
                }, 1000);
            } catch (e) {
                console.error(e);
                alert('Analysis failed. Please try again.');
            }
        }
        // Report buttons
        document.getElementById('conceptGapsBtn').onclick = () => {
            showScreen('conceptGapsScreen');
            renderPerformanceReport();
        };
        document.getElementById('detailedAnalysisBtn').onclick = () => {
            showScreen('detailedAnalysisScreen');
            renderDetailedAnalysis();
        };
        document.getElementById('createPaperBtn').onclick = async () => {
            showScreen('practicePaperScreen');
            await generatePracticePaper();
        };
        // Navigation functions
        function showScreen(screenId) {
            document.querySelectorAll('.report-screen, .main-interface').forEach(el => {
                el.style.display = 'none';
            });
            document.getElementById(screenId).style.display = 'block';
        }
        function showMainInterface() {
            document.querySelectorAll('.report-screen').forEach(el => {
                el.style.display = 'none';
            });
            document.getElementById('mainInterface').style.display = 'block';
        }
        // Back buttons
        document.getElementById('backToAnalysis').onclick =
        document.getElementById('backToAnalysisDetailed').onclick =
        document.getElementById('backToAnalysisPractice').onclick = showMainInterface;
        // Performance Report Rendering with streaming effect - FIXED TABLE SEPARATION
        function renderPerformanceReport() {
            const content = document.getElementById('conceptGapsContent');
            content.innerHTML = '<div class="streaming-placeholder">Generating performance report...</div>';
         
            setTimeout(() => {
                if (!analysisData) {
                    content.innerHTML = '<p>No analysis data available.</p>';
                    return;
                }
             
                // Extract table from analysis data - FIXED: Separate table from insights
                const tableMatch = analysisData.match(/\| Concept No\. \| Concept.*?(?=## Performance Insights|\|\s*$)/s);
                let tableHTML = '<p>Performance data not available</p>';
             
                if (tableMatch) {
                    tableHTML = `
                        <div class="performance-table-container">
                            <h3>Concept Performance Analysis</h3>
                            <table class="performance-table">
                                <thead>
                                    <tr>
                                        <th width="10%">Concept No.</th>
                                        <th width="35%">Concept (With Explanation)</th>
                                        <th width="25%">Example</th>
                                        <th width="30%">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${parsePerformanceTable(tableMatch[0])}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
             
                // Extract insights - FIXED: Separate from table
                const insightsMatch = analysisData.match(/## Performance Insights[\s\S]*$/);
                let insightsHTML = '';
                if (insightsMatch) {
                    const insightsText = insightsMatch[0].replace(/## Performance Insights\s*/, '');
                    insightsHTML = `
                        <div class="performance-insights">
                            <h3>üìä Performance Insights</h3>
                            <div class="insight-content">${formatMathContent(insightsText)}</div>
                        </div>
                    `;
                }
             
                content.innerHTML = tableHTML + insightsHTML;
             
                // Render KaTeX
                setTimeout(() => {
                    renderKaTeX(content);
                }, 500);
            }, 800);
        }
        function parsePerformanceTable(tableText) {
            const rows = tableText.split('\n').filter(line => line.trim().startsWith('|'));
            let tableHTML = '';
         
            rows.forEach((row, index) => {
                if (index < 2) return; // Skip header and separator
             
                const cells = row.split('|').filter(cell => cell.trim() !== '');
                if (cells.length >= 4) {
                    const conceptNumber = cells[0].trim();
                    const conceptText = cells[1].trim();
                    const exampleText = cells[2].trim();
                    const statusText = cells[3].trim();
                 
                    const statusClass = getStatusClass(statusText);
                 
                    tableHTML += `
                        <tr>
                            <td><strong>${conceptNumber}</strong></td>
                            <td>
                                <div class="concept-name">${formatMathContent(conceptText.split('<br/>')[0])}</div>
                                ${conceptText.includes('<br/>') ? `<div class="concept-explanation">${formatMathContent(conceptText.split('<br/>')[1])}</div>` : ''}
                            </td>
                            <td class="math-expression">${formatMathContent(exampleText)}</td>
                            <td><span class="status-performance ${statusClass}">${formatMathContent(statusText)}</span></td>
                        </tr>
                    `;
                }
            });
         
            return tableHTML;
        }
        function getStatusClass(statusText) {
            const text = statusText.toLowerCase();
            if (text.includes('perfect') || text.includes('100%') || text.includes('excellent')) return 'perfect';
            if (text.includes('mistake') || text.includes('error') || text.includes('wrong')) return 'error';
            if (text.includes('partial') || text.includes('50%') || text.includes('needs improvement')) return 'partial';
            if (text.includes('not tested')) return 'not-tested';
            return '';
        }
        // Detailed Analysis Rendering with streaming effect and improved structure
        function renderDetailedAnalysis() {
            const content = document.getElementById('detailedContent');
            content.innerHTML = '<div class="streaming-placeholder">Generating detailed analysis...</div>';
         
            setTimeout(() => {
                content.innerHTML = '';
             
                if (!detailedData.questions || detailedData.questions.length === 0) {
                    content.innerHTML = '<p>No questions analyzed yet.</p>';
                    return;
                }
             
                detailedData.questions.forEach(q => {
                    const hasErrors = q.hasErrors && q.mistakes && q.mistakes.length > 0;
                    const section = document.createElement('div');
                    section.className = 'question-analysis';
                 
                    section.innerHTML = `
                        <div class="question-header" onclick="toggleQuestion('${q.id}')">
                            <span class="question-title">${q.id} - Question Analysis</span>
                            <span class="question-status ${hasErrors ? 'has-errors' : 'no-errors'}">
                                ${hasErrors ? 'üî¥ Errors Found' : 'üü¢ No Major Errors'}
                            </span>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div id="content-${q.id}" class="question-content" style="display: none;">
                            <!-- Question Text -->
                            <div class="analysis-section">
                                <h4>üìù Question:</h4>
                                <div class="math-expression">${formatMathContent(q.questionText)}</div>
                            </div>
                         
                            <!-- Student's Solution - EXACTLY as submitted -->
                            <div class="analysis-section student-work">
                                <h4>‚úçÔ∏è Student's Solution:</h4>
                                ${q.steps && q.steps.length > 0 && q.steps[0] !== "No solution provided" ?
                                    q.steps.map((step, index) => `
                                        <div class="step-item">
                                            <strong>Step ${index + 1}:</strong><br>
                                            <div class="math-expression original-solution">${formatMathContent(step)}</div>
                                        </div>
                                    `).join('') :
                                    '<div class="step-item">No solution provided</div>'
                                }
                            </div>
                         
                            <!-- Error Analysis - SIMPLE AND PRECISE -->
                            <div class="analysis-section error-analysis">
                                <h4>üîç Error Analysis:</h4>
                                ${hasErrors
                                    ? q.mistakes.map(m => `
                                        <div class="step-item error-item">
                                            <div class="error-step">Step ${m.step}:</div>
                                            <div class="error-desc">${formatMathContent(m.desc || m.error)}</div>
                                            ${m.correction ? `
                                                <div class="correction">
                                                    <strong>Correction:</strong>
                                                    <div class="math-expression">${formatMathContent(m.correction)}</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')
                                    : `<div class="step-item correct-item">
                                        <strong>‚úì No Conceptual Errors Found</strong><br>
                                        <em>All steps appear to be mathematically sound.</em>
                                       </div>`
                                }
                            </div>
                         
                            <!-- Correct Solution -->
                            <div class="analysis-section correct-solution">
                                <h4>‚úÖ Correct Solution:</h4>
                                ${(q.correctedSteps || []).map((step, index) => `
                                    <div class="step-item correct-item">
                                        <strong>Step ${index + 1}:</strong><br>
                                        <div class="math-expression">${formatMathContent(step)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    content.appendChild(section);
                });
             
                // Render KaTeX
                setTimeout(() => {
                    renderKaTeX(content);
                }, 500);
            }, 800);
        }
        function toggleQuestion(id) {
            const content = document.getElementById('content-' + id);
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
         
            // Update arrow
            const header = content.previousElementSibling;
            const arrow = header.querySelector('.toggle-icon');
            arrow.textContent = isHidden ? '‚ñ≤' : '‚ñº';
         
            // Render KaTeX when expanding
            if (isHidden) {
                setTimeout(() => {
                    renderKaTeX(content);
                }, 300);
            }
        }
        // Practice Paper Generation - FIXED loading and question number issues
        async function generatePracticePaper() {
            const content = document.getElementById('practicePaperContent');
            content.innerHTML = '<div class="streaming-placeholder">üîç Generating targeted practice paper based on your conceptual errors...</div>';
         
            try {
                // Filter questions with genuine medium/high-level errors
                const questionsWithGenuineErrors = detailedData.questions.filter(q => {
                    if (!q.hasErrors || !q.mistakes || q.mistakes.length === 0) return false;
                 
                    // Check if there are genuine conceptual errors (not just minor deviations)
                    const hasGenuineErrors = q.mistakes.some(m => {
                        const desc = (m.desc || m.error || '').toLowerCase();
                        // Filter out minor errors and focus on conceptual mistakes
                        return !desc.includes('minor') &&
                               !desc.includes('formatting') &&
                               !desc.includes('presentation') &&
                               desc.includes('concept') || desc.includes('method') ||
                               desc.includes('approach') || desc.includes('incorrect');
                    });
                 
                    return hasGenuineErrors;
                });
             
                if (questionsWithGenuineErrors.length === 0) {
                    content.innerHTML = `
                        <div class="no-errors-message">
                            <h3>üéâ Excellent Work!</h3>
                            <p>No significant conceptual errors were found in your solutions.</p>
                            <p><strong>This means you've demonstrated strong understanding of the concepts!</strong></p>
                            <p>If you'd like additional practice, try more advanced problems or different question types.</p>
                        </div>
                    `;
                    return;
                }
             
                const response = await fetch('/create-practice-paper', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        detailed_data: { questions: questionsWithGenuineErrors }
                    })
                });
             
                if (!response.ok) {
                    throw new Error('Failed to generate practice paper');
                }
             
                const data = await response.json();
             
                if (data.success) {
                    practicePaperData = data.practice_paper;
                    renderPracticePaper();
                } else {
                    content.innerHTML = `<p class="error">Failed to generate practice paper: ${data.error}</p>`;
                }
            } catch (e) {
                console.error('Practice paper generation error:', e);
                content.innerHTML = `<p class="error">Error generating practice paper: ${e.message}</p>`;
            }
        }
       function renderPracticePaper() {
    const content = document.getElementById('practicePaperContent');
 
    if (!practicePaperData) {
        content.innerHTML = '<p>No practice paper data available.</p>';
        return;
    }
 
    // Parse and render questions with CORRECT question numbers
    let practiceHTML = `
        <div class="practice-info">
            <h3>Targeted Practice Paper</h3>
            <p>This practice paper focuses on concepts where you need reinforcement.</p>
        </div>
        <div class="practice-questions-container">
    `;
 
    // IMPROVED PARSING - Handle different question number formats
    const questionBlocks = practicePaperData.split(/(?=### Q\d+:)/);
    let questionCount = 0;
 
    questionBlocks.forEach((block) => {
        if (!block.includes('### Q')) return;
     
        questionCount++;
     
        // FIXED: Better regex to capture various question number formats
        const questionMatch = block.match(/### Q(\d+): Modified Form \(Based on Question\s+([^)\n]+)\)/);
        const originalMatch = block.match(/Original Question:\s*(.*?)(?=Modified Question|$)/s);
        const modifiedMatch = block.match(/Modified Question:\s*(.*?)(?=### Q\d+:|$)/s);
     
        if (questionMatch && originalMatch && modifiedMatch) {
            const sequential = questionMatch[1].trim();
            const originalId = questionMatch[2].trim();
            const originalQuestion = originalMatch[1].trim();
            const modifiedQuestion = modifiedMatch[1].trim();
         
            practiceHTML += `
                <div class="practice-question">
                    <div class="question-header-line">
                        <strong>Q${sequential}: Modified Form (Based on Question ${originalId})</strong>
                    </div>
                    <div class="question-content-grid">
                        <div class="original-question-section">
                            <h4>üìù Original Question:</h4>
                            <div class="question-box">
                                <div class="math-expression">${formatMathContent(originalQuestion)}</div>
                            </div>
                        </div>
                        <div class="redesigned-question-section">
                            <h4>üéØ Practice Question:</h4>
                            <div class="question-box">
                                <div class="math-expression">${formatMathContent(modifiedQuestion)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    });
 
    practiceHTML += '</div>';
 
    if (questionCount === 0) {
        // Fallback parsing if main method fails
        practiceHTML = `
            <div class="practice-info">
                <h3>Targeted Practice Paper</h3>
                <p>This practice paper focuses on concepts where you need reinforcement.</p>
            </div>
            <div class="fallback-content">
                <div class="math-expression">${formatMathContent(practicePaperData)}</div>
            </div>
        `;
    }
 
    content.innerHTML = practiceHTML;
 
    // Force KaTeX rendering
    setTimeout(() => {
        renderKaTeX(content);
    }, 100);
}
        // Fallback function to extract questions if main parsing fails
        function extractQuestionsFromText(text) {
            const questions = [];
            const lines = text.split('\n');
            let currentQuestion = null;
         
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
             
                // Look for question patterns
                if (line.includes('Original Question:') || line.includes('Modified Question:')) {
                    if (line.includes('Original Question:')) {
                        if (currentQuestion) questions.push(currentQuestion);
                        currentQuestion = { original: '', modified: '', number: questions.length + 1 };
                        currentQuestion.original = line.replace('Original Question:', '').trim();
                    } else if (line.includes('Modified Question:') && currentQuestion) {
                        currentQuestion.modified = line.replace('Modified Question:', '').trim();
                        questions.push(currentQuestion);
                        currentQuestion = null;
                    }
                } else if (currentQuestion && line) {
                    // Continue building the current question
                    if (currentQuestion.original && !currentQuestion.modified) {
                        currentQuestion.modified += ' ' + line;
                    } else if (!currentQuestion.modified) {
                        currentQuestion.original += ' ' + line;
                    }
                }
            }
         
            if (currentQuestion && currentQuestion.original) {
                questions.push(currentQuestion);
            }
         
            return questions;
        }
        // IMPROVED MATH FORMATTING FUNCTION
        function formatMathContent(text) {
            if (!text) return '';
         
            // Enhanced LaTeX preservation for perfect KaTeX rendering
            let formatted = text
                // Preserve all LaTeX commands
                .replace(/\\\[/g, '\\[')
                .replace(/\\\]/g, '\\]')
                .replace(/\\\(/g, '\\(')
                .replace(/\\\)/g, '\\)')
                .replace(/\\boxed{/g, '\\boxed{')
                .replace(/\\frac{/g, '\\frac{')
                .replace(/\\int/g, '\\int')
                .replace(/\\sqrt{/g, '\\sqrt{')
                .replace(/\\log/g, '\\log')
                .replace(/\\sin/g, '\\sin')
                .replace(/\\cos/g, '\\cos')
                .replace(/\\tan/g, '\\tan')
                .replace(/\\sum/g, '\\sum')
                .replace(/\\prod/g, '\\prod')
                .replace(/\\infty/g, '\\infty')
                .replace(/\\pi/g, '\\pi')
                .replace(/\\theta/g, '\\theta')
                .replace(/\\alpha/g, '\\alpha')
                .replace(/\\beta/g, '\\beta')
                .replace(/\\gamma/g, '\\gamma')
                .replace(/\\delta/g, '\\delta')
                .replace(/\\lambda/g, '\\lambda')
                .replace(/\\mu/g, '\\mu')
                .replace(/\\sigma/g, '\\sigma')
                .replace(/\\omega/g, '\\omega')
                .replace(/\\phi/g, '\\phi')
                .replace(/\\psi/g, '\\psi')
                .replace(/\\xi/g, '\\xi')
                .replace(/\\eta/g, '\\eta')
                .replace(/\\rho/g, '\\rho')
                .replace(/\\tau/g, '\\tau')
                .replace(/\\upsilon/g, '\\upsilon')
                .replace(/\\chi/g, '\\chi')
                .replace(/\\partial/g, '\\partial')
                .replace(/\\nabla/g, '\\nabla')
                .replace(/\\cdot/g, '\\cdot')
                .replace(/\\times/g, '\\times')
                .replace(/\\div/g, '\\div')
                .replace(/\\pm/g, '\\pm')
                .replace(/\\mp/g, '\\mp')
                .replace(/\\leq/g, '\\leq')
                .replace(/\\geq/g, '\\geq')
                .replace(/\\neq/g, '\\neq')
                .replace(/\\approx/g, '\\approx')
                .replace(/\\equiv/g, '\\equiv')
                .replace(/\\propto/g, '\\propto')
                .replace(/\\in/g, '\\in')
                .replace(/\\notin/g, '\\notin')
                .replace(/\\subset/g, '\\subset')
                .replace(/\\subseteq/g, '\\subseteq')
                .replace(/\\supset/g, '\\supset')
                .replace(/\\supseteq/g, '\\supseteq')
                .replace(/\\cup/g, '\\cup')
                .replace(/\\cap/g, '\\cap')
                .replace(/\\emptyset/g, '\\emptyset')
                .replace(/\\mathbb{R}/g, '\\mathbb{R}')
                .replace(/\\mathbb{N}/g, '\\mathbb{N}')
                .replace(/\\mathbb{Z}/g, '\\mathbb{Z}')
                .replace(/\\mathbb{Q}/g, '\\mathbb{Q}')
                .replace(/\\mathbb{C}/g, '\\mathbb{C}')
                .replace(/\\vec/g, '\\vec')
                .replace(/\\hat/g, '\\hat')
                .replace(/\\tilde/g, '\\tilde')
                .replace(/\\dot/g, '\\dot')
                .replace(/\\ddot/g, '\\ddot')
                .replace(/\\prime/g, '\\prime')
                .replace(/\\lim/g, '\\lim')
                .replace(/\\to/g, '\\to')
                .replace(/\\rightarrow/g, '\\rightarrow')
                .replace(/\\leftarrow/g, '\\leftarrow')
                .replace(/\\Rightarrow/g, '\\Rightarrow')
                .replace(/\\Leftarrow/g, '\\Leftarrow')
                .replace(/\\Leftrightarrow/g, '\\Leftrightarrow')
                .replace(/\\forall/g, '\\forall')
                .replace(/\\exists/g, '\\exists')
                .replace(/\\nexists/g, '\\nexists');
         
            // Format text elements while preserving math
            formatted = formatted
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>')
                .replace(/\-{3,}/g, '<hr>');
             
            return formatted;
        }
        // KaTeX Rendering Function
        function renderKaTeX(element = document.body) {
            try {
                renderMathInElement(element, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false},
                        {left: "\\(", right: "\\)", display: false},
                        {left: "\\[", right: "\\]", display: true}
                    ],
                    throwOnError: false,
                    strict: false
                });
            } catch (e) {
                console.log('KaTeX render error:', e);
            }
        }
        // Download Handlers
        document.getElementById('downloadConceptGaps').onclick = () => {
            const element = document.getElementById('conceptGapsContent');
            html2pdf().from(element).save('performance_report.pdf');
        };
        document.getElementById('downloadDetailed').onclick = () => {
            const element = document.getElementById('detailedContent');
            html2pdf().from(element).save('detailed_analysis.pdf');
        };
        document.getElementById('downloadPractice').onclick = () => {
            const element = document.getElementById('practicePaperContent');
            html2pdf().from(element).save('practice_paper.pdf');
        };
        // Initialize
        showMainInterface();
        // Initial render for any static math
        renderKaTeX();
    </script>
</body>
</html>
