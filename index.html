<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload Test - PythonAnywhere</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .upload-box {
            border: 3px dashed #ccc;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            background: #f9f9f9;
        }
        .upload-box:hover {
            border-color: #4361ee;
            background: #eef2ff;
        }
        button {
            background: #4361ee;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .file-list {
            margin: 20px 0;
            background: #f5f7fa;
            padding: 15px;
            border-radius: 8px;
        }
        .file-item {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>üìÅ PythonAnywhere File Upload Test</h1>
    <p>Test if files can be saved to PythonAnywhere server.</p>
    
    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
        <h3>üì§ Click to Select Files</h3>
        <p>Select image files to test upload</p>
    </div>
    
    <input type="file" id="fileInput" multiple style="display: none;" onchange="showSelectedFiles()">
    
    <div id="selectedFiles" class="file-list"></div>
    
    <div>
        <button id="uploadBtn" onclick="uploadFiles()" disabled>Upload to PythonAnywhere</button>
        <button onclick="listFiles()">List Uploaded Files</button>
    </div>
    
    <div id="result"></div>
    
    <script>
        const BACKEND_URL = 'https://navalsheth.pythonanywhere.com';
        let selectedFiles = [];
        
        function showSelectedFiles() {
            const fileInput = document.getElementById('fileInput');
            selectedFiles = Array.from(fileInput.files);
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (selectedFiles.length === 0) {
                document.getElementById('selectedFiles').innerHTML = '<p>No files selected</p>';
                uploadBtn.disabled = true;
                return;
            }
            
            let html = '<h3>Selected Files:</h3>';
            selectedFiles.forEach(file => {
                html += `
                    <div class="file-item">
                        <span>${file.name}</span>
                        <span>${formatBytes(file.size)}</span>
                    </div>
                `;
            });
            
            document.getElementById('selectedFiles').innerHTML = html;
            uploadBtn.disabled = false;
            uploadBtn.textContent = `Upload ${selectedFiles.length} File${selectedFiles.length > 1 ? 's' : ''}`;
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        async function uploadFiles() {
            if (selectedFiles.length === 0) return;
            
            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.textContent;
            uploadBtn.textContent = 'Uploading...';
            uploadBtn.disabled = true;
            
            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });
            
            try {
                console.log('Starting upload to:', BACKEND_URL);
                
                const response = await fetch(`${BACKEND_URL}/test-file-upload`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const data = await response.json();
                console.log('Server response:', data);
                
                if (response.ok) {
                    showResult(`‚úÖ ${data.message}<br>Files saved: ${data.saved_files.length}`, 'success');
                    
                    // Show saved files info
                    if (data.saved_files && data.saved_files.length > 0) {
                        let filesHtml = '<h4>Saved Files:</h4>';
                        data.saved_files.forEach(f => {
                            filesHtml += `<p>${f.original} ‚Üí ${f.saved_as} (${formatBytes(f.size)})</p>`;
                        });
                        showResult(filesHtml, 'success');
                    }
                } else {
                    showResult(`‚ùå Error: ${data.error || 'Upload failed'}`, 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showResult(`‚ùå Network error: ${error.message}`, 'error');
            } finally {
                uploadBtn.textContent = originalText;
                uploadBtn.disabled = false;
            }
        }
        
        async function listFiles() {
            try {
                const response = await fetch(`${BACKEND_URL}/test-list-files`);
                const data = await response.json();
                
                if (data.files && data.files.length > 0) {
                    let html = `<h3>Files in ${data.upload_folder}:</h3>`;
                    data.files.forEach(f => {
                        html += `<div class="file-item">
                            <span>${f.name}</span>
                            <span>${formatBytes(f.size)}</span>
                        </div>`;
                    });
                    html += `<p>Total: ${data.count} files</p>`;
                    showResult(html, 'success');
                } else {
                    showResult('No files found in upload directory.', 'error');
                }
            } catch (error) {
                showResult(`Error listing files: ${error.message}`, 'error');
            }
        }
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
        }
        
        // Add CORS credentials for PythonAnywhere
        fetch(`${BACKEND_URL}/test-file-upload`, { 
            method: 'OPTIONS',
            credentials: 'include'
        }).catch(() => {});
    </script>
</body>
</html>
