<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math.AI Analyzer - CAS Educations</title>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #4361ee; --secondary: #f8f9fa; --destructive: #e63946;
            --card: #ffffff; --background: #f5f7fa; --foreground: #1a1a2e;
            --border: #dee2e6; --radius: 12px; --shadow: 0 4px 6px rgba(0,0,0,0.07);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif; background: var(--background); color: var(--foreground); }
        
        /* Login Page */
        #loginPage { height: 100vh; display: flex; align-items: center; justify-content: center; background: white; }
        .login-container { width: 100%; max-width: 420px; padding: 0 20px; }
        .login-header { text-align: center; margin-bottom: 40px; }
        .login-brand { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
        .login-brand span { color: var(--primary); }
        .login-card { background: var(--card); border-radius: var(--radius); padding: 40px; box-shadow: var(--shadow); }
        .form-group { margin-bottom: 24px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 8px; font-size: 15px; }
        .login-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .error-message { color: var(--destructive); font-size: 14px; margin-top: 8px; text-align: center; display: none; }
        .error-message.show { display: block; }
        
        /* Dashboard */
        .dashboard-container { display: none; height: 100vh; }
        .dashboard-layout { display: flex; height: 100%; }
        .sidebar { width: 280px; background: var(--card); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 24px; border-bottom: 1px solid var(--border); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }
        .sidebar-item { padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 8px; }
        .sidebar-item:hover { background: var(--secondary); }
        .sidebar-item.active { background: var(--primary); color: white; }
        .sidebar-item-title { font-weight: 500; font-size: 14px; margin-bottom: 4px; }
        .sidebar-item-date { font-size: 12px; opacity: 0.7; }
        
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .header { border-bottom: 1px solid var(--border); background: var(--card); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
        .user-info { font-size: 14px; }
        .user-name { color: var(--primary); font-weight: 600; }
        .btn-logout { background: transparent; padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); cursor: pointer; }
        
        .content-area { flex: 1; overflow-y: auto; padding: 24px; }
        .upload-section, .results-section { max-width: 1200px; margin: 0 auto; width: 100%; }
        .upload-grid { display: flex; justify-content: center; gap: 24px; margin-bottom: 32px; flex-wrap: wrap; }
        .upload-card { background: var(--card); border: 2px dashed var(--border); border-radius: var(--radius); padding: 24px; text-align: center; cursor: pointer; max-width: 320px; width: 100%; }
        .btn-start { background: var(--primary); color: white; padding: 12px 48px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin: 0 auto; }
        .btn-start:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .hidden { display: none; }
        .accordion { display: flex; flex-direction: column; gap: 16px; }
        .accordion-item { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); }
        .accordion-trigger { width: 100%; padding: 20px; display: flex; align-items: flex-start; gap: 16px; cursor: pointer; background: none; border: none; text-align: left; }
        .question-number { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .question-number.correct { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .question-number.partial { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .question-number.incorrect { background: rgba(230, 57, 70, 0.1); color: var(--destructive); }
        .accordion-content { display: none; padding: 0 20px 20px; }
        .accordion-content.open { display: block; }
        
        .analysis-section { margin-bottom: 20px; }
        .solution-card { background: var(--secondary); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-top: 12px; }
        .solution-card.error { background: rgba(230, 57, 70, 0.05); border-color: rgba(230, 57, 70, 0.2); }
        .solution-card.corrected { background: rgba(16, 185, 129, 0.05); border-color: rgba(16, 185, 129, 0.2); }
        
        /* Bounding Box Styles */
        .bounding-box-section { margin-top: 20px; padding: 16px; background: rgba(230, 57, 70, 0.05); border: 1px solid rgba(230, 57, 70, 0.2); border-radius: 8px; }
        .corrected-image-container { position: relative; display: inline-block; margin-top: 12px; }
        .corrected-image { width: 100%; max-width: 400px; border-radius: 8px; }
        .bounding-box-overlay { position: absolute; border: 3px solid var(--destructive); border-radius: 4px; pointer-events: none; }
        .error-label { position: absolute; background: rgba(230, 57, 70, 0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; pointer-events: none; }
        
        .btn { padding: 10px 24px; border-radius: 8px; font-weight: 500; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--foreground); }
        
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f4f6; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 50; align-items: center; justify-content: center; padding: 16px; }
        .modal.open { display: flex; }
        .modal-content { background: var(--card); border-radius: var(--radius); max-width: 500px; width: 100%; padding: 24px; }
        
        @media (max-width: 1024px) {
            .sidebar { display: none; }
            .mobile-menu-btn { display: flex; background: transparent; border: none; padding: 8px; cursor: pointer; }
        }
        @media (max-width: 640px) {
            .upload-grid { flex-direction: column; }
            .login-card { padding: 24px; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage">
        <div class="login-container">
            <div class="login-header">
                <div class="login-brand">CAS <span>Educations</span></div>
                <p>AI-Powered Math Analysis Platform</p>
            </div>
            <div class="login-card">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="loginUsername" class="form-input" placeholder="Enter username" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="Enter password" required>
                    </div>
                    <div id="loginErrorMessage" class="error-message"></div>
                    <button type="submit" class="login-btn">Login to Dashboard</button>
                    <button type="button" class="login-btn" style="margin-top:10px;background:#6c757d;" onclick="showRegisterModal()">Register New Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="dashboard-container">
        <div class="dashboard-layout">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-logo" onclick="resetToDashboard()">
                        <h1>Math.AI Analyzer</h1>
                    </div>
                </div>
                <div class="sidebar-content" id="historyList"></div>
            </aside>

            <div class="main-content">
                <header class="header">
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>
                    <div class="header-logo" onclick="resetToDashboard()">
                        <span>CAS Educations</span>
                    </div>
                    <div class="header-right">
                        <p class="user-info">Welcome, <span class="user-name" id="userName"></span></p>
                        <button class="btn-logout" onclick="handleLogout()">Logout</button>
                    </div>
                </header>

                <main class="content-area">
                    <div id="uploadSection" class="upload-section">
                        <div style="text-align:center;margin-bottom:40px;">
                            <h1>Upload Answer Sheets for Analysis</h1>
                            <p>Upload question papers and student answer sheets</p>
                        </div>
                        <div class="upload-grid">
                            <div class="upload-card" onclick="document.getElementById('questionInput').click()">
                                <h3>Question Papers</h3>
                                <p>Upload the original question papers</p>
                                <input type="file" id="questionInput" multiple accept="image/*,.pdf" style="display:none;">
                                <button class="btn-outline" style="margin-top:16px;">Upload Files</button>
                                <div id="questionFileList" class="file-list" style="margin-top:12px;font-size:12px;"></div>
                            </div>
                            <div class="upload-card" onclick="document.getElementById('answerInput').click()">
                                <h3>Student Answer Sheets</h3>
                                <p>Upload student's handwritten answers</p>
                                <input type="file" id="answerInput" multiple accept="image/*,.pdf" style="display:none;">
                                <button class="btn-outline" style="margin-top:16px;">Upload Files</button>
                                <div id="answerFileList" class="file-list" style="margin-top:12px;font-size:12px;"></div>
                            </div>
                        </div>
                        <div style="text-align:center;margin-top:32px;">
                            <button id="startAnalysisBtn" class="btn-start" onclick="startAnalysis()" disabled>Start Analysis</button>
                        </div>
                    </div>

                    <div id="resultsSection" class="results-section hidden">
                        <div style="margin-bottom:32px;">
                            <h1>Analysis Results</h1>
                            <p>AI-powered answer sheet analysis</p>
                            <div id="badgeGroup" style="display:flex;gap:8px;margin-top:16px;"></div>
                        </div>
                        <div class="accordion" id="accordion"></div>
                        <div style="margin-top:40px;text-align:center;">
                            <button id="saveAnalysisBtn" class="btn-primary" style="display:none;" onclick="showSaveModal()">Save Analysis</button>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom:24px;">Create New Account</h3>
            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="registerUsername" class="form-input" placeholder="Username (min 3 chars)" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" id="registerPhone" class="form-input" placeholder="Phone number" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="registerPassword" class="form-input" placeholder="Password (min 6 chars)" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" class="form-input" placeholder="Confirm password" required>
                </div>
                <div id="registerErrorMessage" class="error-message"></div>
                <button type="submit" class="login-btn" style="margin-top:16px;">Register Account</button>
            </form>
            <button class="btn-outline" style="width:100%;margin-top:16px;" onclick="closeRegisterModal()">Cancel</button>
        </div>
    </div>

    <div id="saveModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom:24px;">Save Analysis</h3>
            <div class="form-group">
                <label class="form-label">Analysis Name</label>
                <input type="text" id="analysisName" class="form-input" required>
            </div>
            <div id="saveErrorMessage" class="error-message"></div>
            <button class="login-btn" onclick="saveAnalysisName()">Save</button>
            <button class="btn-outline" style="width:100%;margin-top:16px;" onclick="closeSaveModal()">Cancel</button>
        </div>
    </div>

    <script>
        // Configuration
        const BACKEND_URL = 'https://navalsheth.pythonanywhere.com';
        
        // State Management
        let state = {
            questionFiles: [],
            answerFiles: [],
            analysisResult: null,
            currentUser: null,
            currentAnalysisId: null,
            analyses: []
        };

        // Core Functions
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${BACKEND_URL}${endpoint}`, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Auth Functions
        async function checkAuth() {
            try {
                const data = await apiCall('/api/check-auth', { method: 'GET' });
                if (data.authenticated && data.user) {
                    state.currentUser = data.user;
                    return true;
                }
                return false;
            } catch { return false; }
        }

        async function loginUser(username, password) {
            const errorMsg = document.getElementById('loginErrorMessage');
            errorMsg.classList.remove('show');
            
            try {
                const data = await apiCall('/api/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                
                if (data.success) {
                    state.currentUser = data.user;
                    showDashboard();
                } else {
                    errorMsg.textContent = data.message;
                    errorMsg.classList.add('show');
                }
            } catch {
                errorMsg.textContent = 'Connection error';
                errorMsg.classList.add('show');
            }
        }

        async function registerUser(username, phone, password) {
            const errorMsg = document.getElementById('registerErrorMessage');
            errorMsg.classList.remove('show');
            
            try {
                const data = await apiCall('/api/register', {
                    method: 'POST',
                    body: JSON.stringify({ username, phone, password })
                });
                
                if (data.success) {
                    closeRegisterModal();
                    alert('Registration successful! Please login.');
                } else {
                    errorMsg.textContent = data.message;
                    errorMsg.classList.add('show');
                }
            } catch {
                errorMsg.textContent = 'Connection error';
                errorMsg.classList.add('show');
            }
        }

        async function logoutUser() {
            try { await apiCall('/api/logout', { method: 'POST' }); } catch {}
            state.currentUser = null;
            showLoginPage();
        }

        // UI Functions
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboardPage').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'flex';
            document.getElementById('userName').textContent = state.currentUser.username;
            loadAnalyses();
        }

        function resetToDashboard() {
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('saveAnalysisBtn').style.display = 'none';
        }

        function toggleMobileMenu() {
            document.querySelector('.sidebar').style.display = 
                document.querySelector('.sidebar').style.display === 'none' ? 'flex' : 'none';
        }

        // File Upload
        document.getElementById('questionInput').addEventListener('change', (e) => 
            handleFileUpload(e.target.files, 'questionFiles', 'questionFileList'));
        document.getElementById('answerInput').addEventListener('change', (e) => 
            handleFileUpload(e.target.files, 'answerFiles', 'answerFileList'));

        function handleFileUpload(files, type, listId) {
            for (let file of files) {
                if (!state[type].find(f => f.name === file.name)) {
                    state[type].push({ name: file.name, file });
                }
            }
            updateFileList(listId, state[type]);
            checkStartButton();
        }

        function updateFileList(listId, files) {
            document.getElementById(listId).innerHTML = files.map(f => 
                `<div style="padding:4px;background:#f8f9fa;border-radius:4px;margin:2px 0;">${f.name}</div>`
            ).join('');
        }

        function checkStartButton() {
            document.getElementById('startAnalysisBtn').disabled = 
                state.questionFiles.length === 0 || state.answerFiles.length === 0;
        }

        // Analysis Functions
        async function startAnalysis() {
            if (!await checkAuth()) {
                alert('Please login');
                showLoginPage();
                return;
            }

            const btn = document.getElementById('startAnalysisBtn');
            btn.innerHTML = '<div class="loading"></div> Analyzing...';
            btn.disabled = true;

            const formData = new FormData();
            [...state.questionFiles, ...state.answerFiles].forEach(f => 
                formData.append('files', f.file, f.name));

            try {
                const response = await fetch(`${BACKEND_URL}/analyze`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                state.analysisResult = data;
                displayAnalysis(data);
                resetToDashboard();
                document.getElementById('resultsSection').classList.remove('hidden');
                document.getElementById('saveAnalysisBtn').style.display = 'flex';
                
                await loadAnalyses();
                showSaveModal();
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.innerHTML = 'Start Analysis';
                btn.disabled = false;
            }
        }

        function displayAnalysis(result) {
            const accordion = document.getElementById('accordion');
            accordion.innerHTML = '';
            
            const questions = result.questions || [];
            const counts = { correct: 0, partial: 0, incorrect: 0 };
            questions.forEach(q => counts[q.status]++);
            
            questions.forEach((q, i) => {
                const item = document.createElement('div');
                item.className = 'accordion-item';
                
                item.innerHTML = `
                    <button class="accordion-trigger" onclick="toggleAccordion(${i})">
                        <div class="question-number ${q.status}">${q.number}</div>
                        <div style="flex:1;">
                            <p>${q.question}</p>
                            <p>Status: ${q.status.toUpperCase()}</p>
                        </div>
                    </button>
                    <div id="accordionContent${i}" class="accordion-content">
                        <div class="analysis-section">
                            <h3>Student Solution</h3>
                            <div class="solution-card">${q.student_original}</div>
                        </div>
                        <div class="analysis-section">
                            <h3>Error Analysis</h3>
                            <div class="solution-card error">${q.error || 'No errors'}</div>
                        </div>
                        <div class="analysis-section">
                            <h3>Correct Solution</h3>
                            <div class="solution-card corrected">${q.correct_solution}</div>
                        </div>
                        ${q.status !== 'correct' && q.bounding_boxes && q.bounding_boxes.length > 0 ? 
                            `<div id="boundingBoxSection${i}" class="bounding-box-section">
                                <h3>Mistake Highlights</h3>
                                <p>Click image to view full size</p>
                            </div>` : ''}
                    </div>
                `;
                accordion.appendChild(item);
                
                if (q.status !== 'correct' && q.bounding_boxes && q.bounding_boxes.length > 0) {
                    setTimeout(() => loadBoundingBoxes(i, q), 100);
                }
            });
            
            document.getElementById('badgeGroup').innerHTML = `
                <div style="padding:6px 12px;background:#f8f9fa;border-radius:6px;display:flex;align-items:center;gap:8px;">
                    <div style="width:8px;height:8px;background:#10b981;border-radius:50%;"></div>
                    ${counts.correct} Correct
                </div>
                <div style="padding:6px 12px;background:#f8f9fa;border-radius:6px;display:flex;align-items:center;gap:8px;">
                    <div style="width:8px;height:8px;background:#f59e0b;border-radius:50%;"></div>
                    ${counts.partial} Partial
                </div>
                <div style="padding:6px 12px;background:#f8f9fa;border-radius:6px;display:flex;align-items:center;gap:8px;">
                    <div style="width:8px;height:8px;background:var(--destructive);border-radius:50%;"></div>
                    ${counts.incorrect} Incorrect
                </div>
            `;
            
            setTimeout(() => MathJax.typesetPromise(), 100);
        }

        async function loadBoundingBoxes(index, question) {
            if (!state.currentAnalysisId || !question.bounding_boxes || question.bounding_boxes.length === 0) return;
            
            try {
                const data = await apiCall(`/api/get-question-image/${state.currentAnalysisId}/${question.number}`, {
                    method: 'GET'
                });
                
                if (data.success && data.image_data.corrected_image_path) {
                    const section = document.getElementById(`boundingBoxSection${index}`);
                    if (!section) return;
                    
                    section.innerHTML += `
                        <div class="corrected-image-container">
                            <img src="${BACKEND_URL}/api/question-image/${data.image_data.corrected_image_path}" 
                                 class="corrected-image" alt="Corrected Q${question.number}"
                                 onclick="showFullImage('${data.image_data.corrected_image_path}', ${JSON.stringify(question.bounding_boxes)})">
                        </div>
                    `;
                    
                    const img = section.querySelector('.corrected-image');
                    img.onload = () => {
                        const container = img.parentElement;
                        question.bounding_boxes.forEach(bbox => {
                            const overlay = document.createElement('div');
                            overlay.className = 'bounding-box-overlay';
                            const scaleX = img.width / 1000;
                            const scaleY = img.height / 1500;
                            overlay.style.left = `${bbox.x * scaleX}px`;
                            overlay.style.top = `${bbox.y * scaleY}px`;
                            overlay.style.width = `${bbox.width * scaleX}px`;
                            overlay.style.height = `${bbox.height * scaleY}px`;
                            container.appendChild(overlay);
                            
                            const label = document.createElement('div');
                            label.className = 'error-label';
                            label.textContent = bbox.error_type || 'Mistake';
                            label.style.left = `${bbox.x * scaleX}px`;
                            label.style.top = `${(bbox.y * scaleY) - 30}px`;
                            container.appendChild(label);
                        });
                    };
                }
            } catch (error) {
                console.error('Failed to load bounding boxes:', error);
            }
        }

        function showFullImage(filename, bboxes) {
            const w = window.open('', '_blank');
            w.document.write(`
                <html><head><title>Corrected Image</title><style>
                    body { margin: 0; padding: 20px; background: #f5f5f5; text-align: center; }
                    img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
                    .container { position: relative; display: inline-block; }
                    .box { position: absolute; border: 3px solid #e63946; border-radius: 4px; }
                    .label { position: absolute; background: rgba(230,57,70,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
                </style></head>
                <body>
                    <div class="container">
                        <img src="${BACKEND_URL}/api/question-image/${filename}" 
                             onload="initBoxes(this)" style="display:none;">
                    </div>
                    <script>
                        function initBoxes(img) {
                            const container = img.parentElement;
                            img.style.display = 'block';
                            ${JSON.stringify(bboxes)}.forEach(bbox => {
                                const box = document.createElement('div');
                                box.className = 'box';
                                const scaleX = img.width / 1000;
                                const scaleY = img.height / 1500;
                                box.style.left = \`\${bbox.x * scaleX}px\`;
                                box.style.top = \`\${bbox.y * scaleY}px\`;
                                box.style.width = \`\${bbox.width * scaleX}px\`;
                                box.style.height = \`\${bbox.height * scaleY}px\`;
                                container.appendChild(box);
                                
                                const label = document.createElement('div');
                                label.className = 'label';
                                label.textContent = bbox.error_type || 'Mistake';
                                label.style.left = \`\${bbox.x * scaleX}px\`;
                                label.style.top = \`\${(bbox.y * scaleY) - 30}px\`;
                                container.appendChild(label);
                            });
                        }
                    <\/script>
                </body></html>
            `);
            w.document.close();
        }

        function toggleAccordion(index) {
            const content = document.getElementById(`accordionContent${index}`);
            content.classList.toggle('open');
        }

        // Analysis Management
        async function loadAnalyses() {
            try {
                const data = await apiCall('/api/get-analyses', { method: 'GET' });
                if (data.success) {
                    state.analyses = data.analyses;
                    renderAnalyses();
                }
            } catch {}
        }

        function renderAnalyses() {
            const html = state.analyses.map(a => `
                <div class="sidebar-item ${a.id === state.currentAnalysisId ? 'active' : ''}" 
                     onclick="loadAnalysis(${a.id})">
                    <div class="sidebar-item-title">${a.analysis_name}</div>
                    <div class="sidebar-item-date">${a.formatted_date}</div>
                </div>
            `).join('');
            document.getElementById('historyList').innerHTML = html;
        }

        async function loadAnalysis(id) {
            try {
                const data = await apiCall(`/api/get-analysis/${id}`, { method: 'GET' });
                if (data.success) {
                    state.currentAnalysisId = id;
                    state.analysisResult = { questions: data.analysis.analysis_structure?.questions || [] };
                    
                    displayAnalysis(state.analysisResult);
                    document.getElementById('uploadSection').classList.add('hidden');
                    document.getElementById('resultsSection').classList.remove('hidden');
                    document.getElementById('saveAnalysisBtn').style.display = 'flex';
                    
                    // Load bounding boxes for each question
                    if (data.analysis.question_images) {
                        data.analysis.question_images.forEach(img => {
                            const question = state.analysisResult.questions.find(q => q.number === img.question_number);
                            if (question && img.bounding_boxes && img.bounding_boxes.length > 0) {
                                question.bounding_boxes = img.bounding_boxes;
                                const index = state.analysisResult.questions.indexOf(question);
                                setTimeout(() => loadBoundingBoxes(index, question), 100);
                            }
                        });
                    }
                }
            } catch {}
        }

        // Modal Functions
        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('open');
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('open');
            document.getElementById('registerForm').reset();
            document.getElementById('registerErrorMessage').classList.remove('show');
        }

        function showSaveModal() {
            document.getElementById('analysisName').value = `Analysis ${new Date().toLocaleString()}`;
            document.getElementById('saveModal').classList.add('open');
        }

        function closeSaveModal() {
            document.getElementById('saveModal').classList.remove('open');
        }

        async function saveAnalysisName() {
            const name = document.getElementById('analysisName').value.trim();
            if (!name) return alert('Name is required');
            
            try {
                const data = await apiCall(`/api/update-analysis-name/${state.currentAnalysisId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ analysis_name: name })
                });
                
                if (data.success) {
                    closeSaveModal();
                    loadAnalyses();
                } else {
                    alert(data.error);
                }
            } catch {
                alert('Connection error');
            }
        }

        // Event Listeners
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (username && password) loginUser(username, password);
        });

        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirmPassword').value;
            
            if (password !== confirm) {
                document.getElementById('registerErrorMessage').textContent = 'Passwords do not match';
                document.getElementById('registerErrorMessage').classList.add('show');
                return;
            }
            
            if (username.length < 3 || password.length < 6) {
                document.getElementById('registerErrorMessage').textContent = 'Username min 3 chars, password min 6 chars';
                document.getElementById('registerErrorMessage').classList.add('show');
                return;
            }
            
            registerUser(username, phone, password);
        });

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) logoutUser();
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            if (await checkAuth()) showDashboard();
        });
    </script>
</body>
</html>
