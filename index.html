<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math AI Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {inlineMath: [['$', '$']]}
        };
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f7fa; }
        
        /* Login */
        #loginPage { display: flex; height: 100vh; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 300px; }
        .login-box input, .login-box button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
        .login-box button { background: #4361ee; color: white; border: none; cursor: pointer; }
        
        /* Dashboard */
        #dashboardPage { display: none; height: 100vh; }
        .sidebar { width: 250px; background: white; border-right: 1px solid #ddd; padding: 20px; height: 100%; }
        .main { flex: 1; padding: 20px; overflow: auto; }
        .header { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd; }
        
        /* Upload */
        .upload-area { border: 2px dashed #4361ee; padding: 30px; text-align: center; border-radius: 10px; margin: 20px 0; cursor: pointer; }
        
        /* Results */
        .question { background: white; border-radius: 10px; padding: 15px; margin: 10px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .status { padding: 3px 8px; border-radius: 5px; font-size: 12px; }
        .correct { background: #d4edda; color: #155724; }
        .incorrect { background: #f8d7da; color: #721c24; }
        .partial { background: #fff3cd; color: #856404; }
        
        .btn { padding: 10px 20px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn-outline { background: white; color: #4361ee; border: 1px solid #4361ee; }
        
        .hidden { display: none !important; }
        .flex { display: flex; }
    </style>
</head>
<body>
    <!-- Login -->
    <div id="loginPage">
        <div class="login-box">
            <h2>Math AI Analyzer</h2>
            <div id="loginForm">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button onclick="login()">Login</button>
                <button class="btn-outline" onclick="showRegister()">Register</button>
                <div id="loginError" style="color: red; margin-top: 10px;"></div>
            </div>
            <div id="registerForm" class="hidden">
                <input type="text" id="regUsername" placeholder="Username" required>
                <input type="password" id="regPassword" placeholder="Password (min 6)" required>
                <button onclick="register()">Register</button>
                <button class="btn-outline" onclick="showLogin()">Back to Login</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="flex">
        <div class="sidebar">
            <h3>History</h3>
            <div id="historyList"></div>
        </div>
        <div class="main">
            <div class="header">
                <h2>Math AI Analyzer</h2>
                <div>
                    <span id="userName"></span>
                    <button onclick="logout()" class="btn-outline">Logout</button>
                </div>
            </div>
            
            <!-- Upload -->
            <div id="uploadSection">
                <h3>Upload Answer Sheets</h3>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <p>Click or drag files here</p>
                    <input type="file" id="fileInput" multiple accept="image/*,.pdf" style="display:none;">
                </div>
                <div id="fileList"></div>
                <button class="btn" onclick="startAnalysis()">Analyze</button>
            </div>
            
            <!-- Results -->
            <div id="resultsSection" class="hidden">
                <div class="header">
                    <h3>Analysis Results</h3>
                    <button class="btn" onclick="saveAnalysis()">Save</button>
                </div>
                <div id="results"></div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="generatePractice()">Generate Practice Paper</button>
                    <button class="btn" onclick="boundingAnalysis()">Bounding Box Analysis</button>
                </div>
                
                <div id="practiceSection" class="hidden">
                    <h4>Practice Paper</h4>
                    <div id="practiceContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        let currentUser = null;
        let uploadedFiles = [];
        let analysisResult = null;

        // Auth
        async function checkAuth() {
            try {
                const res = await fetch(`${API_URL}/api/check-auth`, { credentials: 'include' });
                const data = await res.json();
                if (data.authenticated) {
                    currentUser = data.user;
                    showDashboard();
                }
            } catch (e) { /* Not logged in */ }
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const res = await fetch(`${API_URL}/api/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password}),
                credentials: 'include'
            });
            
            const data = await res.json();
            if (data.success) {
                currentUser = data.user;
                showDashboard();
            } else {
                document.getElementById('loginError').textContent = data.message;
            }
        }

        async function register() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            
            const res = await fetch(`${API_URL}/api/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password}),
                credentials: 'include'
            });
            
            const data = await res.json();
            if (data.success) {
                alert('Registered! Please login');
                showLogin();
            } else {
                alert(data.message);
            }
        }

        async function logout() {
            await fetch(`${API_URL}/api/logout`, {method: 'POST', credentials: 'include'});
            currentUser = null;
            showLoginPage();
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboardPage').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.username;
            loadHistory();
        }

        // File handling
        document.getElementById('fileInput').addEventListener('change', (e) => {
            uploadedFiles = Array.from(e.target.files);
            const list = document.getElementById('fileList');
            list.innerHTML = uploadedFiles.map(f => `<div>${f.name}</div>`).join('');
        });

        // Analysis
        async function startAnalysis() {
            if (uploadedFiles.length === 0) {
                alert('Upload files first');
                return;
            }
            
            const formData = new FormData();
            uploadedFiles.forEach(f => formData.append('files', f));
            
            const res = await fetch(`${API_URL}/api/analyze`, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
            
            const data = await res.json();
            if (data.questions) {
                analysisResult = data;
                displayResults(data.questions);
                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
            } else {
                alert('Analysis failed: ' + (data.error || 'Unknown error'));
            }
        }

        function displayResults(questions) {
            const container = document.getElementById('results');
            container.innerHTML = questions.map(q => `
                <div class="question">
                    <h4>Question ${q.number} <span class="status ${q.status}">${q.status}</span></h4>
                    <p><strong>Question:</strong> ${q.question}</p>
                    <p><strong>Student's Solution:</strong> ${q.student_solution}</p>
                    <p><strong>Error:</strong> ${q.error}</p>
                    <p><strong>Corrected:</strong> ${q.corrected}</p>
                </div>
            `).join('');
            
            // Render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([container]);
            }
        }

        async function saveAnalysis() {
            if (!analysisResult) return;
            
            const title = prompt('Analysis name:', `Analysis ${new Date().toLocaleString()}`);
            if (!title) return;
            
            const res = await fetch(`${API_URL}/api/save-analysis`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    title,
                    analysis_data: analysisResult
                }),
                credentials: 'include'
            });
            
            const data = await res.json();
            if (data.success) {
                alert('Saved!');
                loadHistory();
            }
        }

        async function loadHistory() {
            const res = await fetch(`${API_URL}/api/get-analyses`, {credentials: 'include'});
            const data = await res.json();
            
            if (data.success) {
                const list = document.getElementById('historyList');
                list.innerHTML = data.analyses.map(a => `
                    <div onclick="loadAnalysis(${a.id})" style="padding: 5px; border-bottom: 1px solid #eee; cursor: pointer;">
                        ${a.title}
                        <small>${a.date}</small>
                    </div>
                `).join('');
            }
        }

        async function loadAnalysis(id) {
            const res = await fetch(`${API_URL}/api/get-analysis/${id}`, {credentials: 'include'});
            const data = await res.json();
            
            if (data.success) {
                analysisResult = data.analysis.analysis_data;
                displayResults(analysisResult.questions || []);
                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
            }
        }

        async function boundingAnalysis() {
            if (uploadedFiles.length === 0) {
                alert('Upload files first');
                return;
            }
            
            const formData = new FormData();
            uploadedFiles.forEach(f => formData.append('files', f));
            formData.append('analysis_id', 'temp_' + Date.now());
            
            const res = await fetch(`${API_URL}/api/bounding-analyze`, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
            
            const data = await res.json();
            if (data.success) {
                alert(`Found ${data.errors_found} errors!`);
                // Display corrected images
                if (data.corrected_images && data.corrected_images.length > 0) {
                    const container = document.getElementById('results');
                    data.corrected_images.forEach(img => {
                        container.innerHTML += `
                            <h4>Corrected Image ${img.index + 1}</h4>
                            <img src="${img.image_base64}" style="max-width: 100%; border: 2px solid red;">
                        `;
                    });
                }
            }
        }

        async function generatePractice() {
            if (!analysisResult || !analysisResult.questions) return;
            
            const res = await fetch(`${API_URL}/api/generate-practice`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({questions: analysisResult.questions}),
                credentials: 'include'
            });
            
            const data = await res.json();
            if (data.practice_questions) {
                const container = document.getElementById('practiceContent');
                container.innerHTML = data.practice_questions.map(q => `
                    <div class="question">
                        <h4>Practice Question ${q.number}</h4>
                        <p>${q.question}</p>
                    </div>
                `).join('');
                document.getElementById('practiceSection').classList.remove('hidden');
                
                if (window.MathJax) {
                    MathJax.typesetPromise([container]);
                }
            }
        }

        // Initialize
        checkAuth();
    </script>
</body>
</html>
